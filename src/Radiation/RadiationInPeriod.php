<?php


namespace Sundata\Utilities\Radiation;

use InvalidArgumentException;
use Sundata\Utilities\Time\DateSplitter;
use Sundata\Utilities\Time\Period;

class RadiationInPeriod
{
    const LAST_DAY = 366;

    public static function getAvgRadiation(Period $period): float
    {
        if (self::isMaxOf366days($period)) {
            return self::getAvgRadiationWithin1Year($period);
        }

        $periods = DateSplitter::splitPeriodInYears($period);
        $radiation = 0;
        foreach ($periods as $period) {
            $radiation += self::getAvgRadiationWithin1Year($period);
        }
        return $radiation;
    }

    public static function getRadiationPercentageOf7YAverage(Period $period): float
    {
        $radiation = self::getAvgRadiation($period);
        return ($radiation * 100) / self::getYearTotal();
    }

    private static function getYearTotal()
    {
        return self::AVG_CUM_RADIATION_PER_DAY["year"];
    }

    private static function isMaxOf366days(Period $period): bool
    {
        $totalDays = $period->getStart()->diffInDays($period->getEnd()) + 1;
        return $totalDays < self::maxDaysForCalculation();
    }

    /**
     * @param Period $period
     * @return float|int|mixed
     */
    private static function getAvgRadiationWithin1Year(Period $period)
    {
        $start = $period->getStart();
        $end = $period->getEnd();

        $startIndex = $start->format('m-d');
        $endIndex = $end->format('m-d');

        if ($start->isAfter($end))
            throw new InvalidArgumentException("Start can't be after end");
        if ($start->eq($end))
            return 0.0;

        // tricky bcs leap days
        else if ($start->day === $end->day && $start->month === $end->month) {
            return $start->year === $end->year
                ? 0.0
                : self::AVG_CUM_RADIATION_PER_DAY["year"];

        } else {
            if ($start->dayOfYear < $end->dayOfYear) {
                return self::AVG_CUM_RADIATION_PER_DAY[$endIndex]
                    - self::AVG_CUM_RADIATION_PER_DAY[$startIndex];

            } else {
                $firstPart = self::AVG_CUM_RADIATION_PER_DAY["year"]
                    - self::AVG_CUM_RADIATION_PER_DAY[$startIndex];
                $secondPart = self::AVG_CUM_RADIATION_PER_DAY[$endIndex];
                return $firstPart + $secondPart;
            }
        }
    }

    private static function maxDaysForCalculation(): int
    {
        return self::LAST_DAY;
    }

    // seven year (2014-2020) average,
    const AVG_CUM_RADIATION_PER_DAY = [
        "01-01" => 0,
        "01-02" => 166,
        "01-03" => 347,
        "01-04" => 486,
        "01-05" => 648,
        "01-06" => 822,
        "01-07" => 1054,
        "01-08" => 1232,
        "01-09" => 1420,
        "01-10" => 1577,
        "01-11" => 1764,
        "01-12" => 1940,
        "01-13" => 2105,
        "01-14" => 2298,
        "01-15" => 2508,
        "01-16" => 2636,
        "01-17" => 2913,
        "01-18" => 3200,
        "01-19" => 3504,
        "01-20" => 3852,
        "01-21" => 4122,
        "01-22" => 4423,
        "01-23" => 4697,
        "01-24" => 4901,
        "01-25" => 5104,
        "01-26" => 5321,
        "01-27" => 5616,
        "01-28" => 5862,
        "01-29" => 6175,
        "01-30" => 6439,
        "01-31" => 6760,
        "02-01" => 7019,
        "02-02" => 7256,
        "02-03" => 7586,
        "02-04" => 8049,
        "02-05" => 8384,
        "02-06" => 8785,
        "02-07" => 9214,
        "02-08" => 9652,
        "02-09" => 9962,
        "02-10" => 10199,
        "02-11" => 10497,
        "02-12" => 10895,
        "02-13" => 11432,
        "02-14" => 11967,
        "02-15" => 12514,
        "02-16" => 13127,
        "02-17" => 13818,
        "02-18" => 14419,
        "02-19" => 15087,
        "02-20" => 15600,
        "02-21" => 15930,
        "02-22" => 16456,
        "02-23" => 16920,
        "02-24" => 17581,
        "02-25" => 18324,
        "02-26" => 19062,
        "02-27" => 19646,
        "02-28" => 20349,
        "02-29" => 20349,
        "03-01" => 21061,
        "03-02" => 21756,
        "03-03" => 22435,
        "03-04" => 22823,
        "03-05" => 23630,
        "03-06" => 24479,
        "03-07" => 25047,
        "03-08" => 25781,
        "03-09" => 26622,
        "03-10" => 27389,
        "03-11" => 28304,
        "03-12" => 29175,
        "03-13" => 30251,
        "03-14" => 31249,
        "03-15" => 32121,
        "03-16" => 33004,
        "03-17" => 33666,
        "03-18" => 34688,
        "03-19" => 35551,
        "03-20" => 36482,
        "03-21" => 37322,
        "03-22" => 38154,
        "03-23" => 39278,
        "03-24" => 40382,
        "03-25" => 41769,
        "03-26" => 42873,
        "03-27" => 43885,
        "03-28" => 45188,
        "03-29" => 46218,
        "03-30" => 47402,
        "03-31" => 48733,
        "04-01" => 49970,
        "04-02" => 51170,
        "04-03" => 52543,
        "04-04" => 53691,
        "04-05" => 54675,
        "04-06" => 56138,
        "04-07" => 57283,
        "04-08" => 58652,
        "04-09" => 60152,
        "04-10" => 61820,
        "04-11" => 63410,
        "04-12" => 64933,
        "04-13" => 66429,
        "04-14" => 68041,
        "04-15" => 69620,
        "04-16" => 71104,
        "04-17" => 72851,
        "04-18" => 74478,
        "04-19" => 76418,
        "04-20" => 78170,
        "04-21" => 80297,
        "04-22" => 82223,
        "04-23" => 84120,
        "04-24" => 85989,
        "04-25" => 87598,
        "04-26" => 89194,
        "04-27" => 90628,
        "04-28" => 92167,
        "04-29" => 93664,
        "04-30" => 94975,
        "05-01" => 96218,
        "05-02" => 97850,
        "05-03" => 99476,
        "05-04" => 101124,
        "05-05" => 102980,
        "05-06" => 104883,
        "05-07" => 106912,
        "05-08" => 108805,
        "05-09" => 110628,
        "05-10" => 112613,
        "05-11" => 114546,
        "05-12" => 116460,
        "05-13" => 118329,
        "05-14" => 120198,
        "05-15" => 122406,
        "05-16" => 124669,
        "05-17" => 126553,
        "05-18" => 128557,
        "05-19" => 130335,
        "05-20" => 132086,
        "05-21" => 134062,
        "05-22" => 135766,
        "05-23" => 137936,
        "05-24" => 139686,
        "05-25" => 141645,
        "05-26" => 143542,
        "05-27" => 145412,
        "05-28" => 147295,
        "05-29" => 149155,
        "05-30" => 151080,
        "05-31" => 152979,
        "06-01" => 154714,
        "06-02" => 157024,
        "06-03" => 158817,
        "06-04" => 160393,
        "06-05" => 162351,
        "06-06" => 164113,
        "06-07" => 166378,
        "06-08" => 168608,
        "06-09" => 170321,
        "06-10" => 172382,
        "06-11" => 174638,
        "06-12" => 176989,
        "06-13" => 178538,
        "06-14" => 180437,
        "06-15" => 182307,
        "06-16" => 184303,
        "06-17" => 185925,
        "06-18" => 187675,
        "06-19" => 189456,
        "06-20" => 190861,
        "06-21" => 192695,
        "06-22" => 194421,
        "06-23" => 196236,
        "06-24" => 198339,
        "06-25" => 200222,
        "06-26" => 202279,
        "06-27" => 204487,
        "06-28" => 206646,
        "06-29" => 208360,
        "06-30" => 210632,
        "07-01" => 212696,
        "07-02" => 214574,
        "07-03" => 216692,
        "07-04" => 219020,
        "07-05" => 221292,
        "07-06" => 223188,
        "07-07" => 224861,
        "07-08" => 226968,
        "07-09" => 228609,
        "07-10" => 230134,
        "07-11" => 231766,
        "07-12" => 233644,
        "07-13" => 235273,
        "07-14" => 236892,
        "07-15" => 238708,
        "07-16" => 240154,
        "07-17" => 242136,
        "07-18" => 244183,
        "07-19" => 246277,
        "07-20" => 248340,
        "07-21" => 250147,
        "07-22" => 252368,
        "07-23" => 254667,
        "07-24" => 256912,
        "07-25" => 258990,
        "07-26" => 260402,
        "07-27" => 262203,
        "07-28" => 264074,
        "07-29" => 265350,
        "07-30" => 267102,
        "07-31" => 268971,
        "08-01" => 270842,
        "08-02" => 272842,
        "08-03" => 274589,
        "08-04" => 276347,
        "08-05" => 277968,
        "08-06" => 279893,
        "08-07" => 281870,
        "08-08" => 283919,
        "08-09" => 285404,
        "08-10" => 286968,
        "08-11" => 288500,
        "08-12" => 290312,
        "08-13" => 291789,
        "08-14" => 293425,
        "08-15" => 294973,
        "08-16" => 296312,
        "08-17" => 297825,
        "08-18" => 298949,
        "08-19" => 300202,
        "08-20" => 301812,
        "08-21" => 303422,
        "08-22" => 304990,
        "08-23" => 306737,
        "08-24" => 308256,
        "08-25" => 309925,
        "08-26" => 311465,
        "08-27" => 312914,
        "08-28" => 314257,
        "08-29" => 315711,
        "08-30" => 317177,
        "08-31" => 318480,
        "09-01" => 319844,
        "09-02" => 321339,
        "09-03" => 322760,
        "09-04" => 323814,
        "09-05" => 324904,
        "09-06" => 325937,
        "09-07" => 326927,
        "09-08" => 328111,
        "09-09" => 329433,
        "09-10" => 330660,
        "09-11" => 331857,
        "09-12" => 333073,
        "09-13" => 334205,
        "09-14" => 335597,
        "09-15" => 336887,
        "09-16" => 338237,
        "09-17" => 339231,
        "09-18" => 340369,
        "09-19" => 341408,
        "09-20" => 342583,
        "09-21" => 343708,
        "09-22" => 344997,
        "09-23" => 345878,
        "09-24" => 346856,
        "09-25" => 347734,
        "09-26" => 348732,
        "09-27" => 349574,
        "09-28" => 350681,
        "09-29" => 351617,
        "09-30" => 352476,
        "10-01" => 353319,
        "10-02" => 354179,
        "10-03" => 354919,
        "10-04" => 355826,
        "10-05" => 356534,
        "10-06" => 357375,
        "10-07" => 358055,
        "10-08" => 358654,
        "10-09" => 359223,
        "10-10" => 359904,
        "10-11" => 360752,
        "10-12" => 361431,
        "10-13" => 362135,
        "10-14" => 362737,
        "10-15" => 363332,
        "10-16" => 363982,
        "10-17" => 364521,
        "10-18" => 365151,
        "10-19" => 365786,
        "10-20" => 366355,
        "10-21" => 366855,
        "10-22" => 367210,
        "10-23" => 367691,
        "10-24" => 368158,
        "10-25" => 368603,
        "10-26" => 369010,
        "10-27" => 369478,
        "10-28" => 370166,
        "10-29" => 370648,
        "10-30" => 371037,
        "10-31" => 371532,
        "11-01" => 372056,
        "11-02" => 372526,
        "11-03" => 373036,
        "11-04" => 373460,
        "11-05" => 373878,
        "11-06" => 374221,
        "11-07" => 374652,
        "11-08" => 375014,
        "11-09" => 375469,
        "11-10" => 375857,
        "11-11" => 376203,
        "11-12" => 376473,
        "11-13" => 376770,
        "11-14" => 377196,
        "11-15" => 377468,
        "11-16" => 377670,
        "11-17" => 377816,
        "11-18" => 378156,
        "11-19" => 378400,
        "11-20" => 378680,
        "11-21" => 378898,
        "11-22" => 379141,
        "11-23" => 379414,
        "11-24" => 379715,
        "11-25" => 379975,
        "11-26" => 380235,
        "11-27" => 380524,
        "11-28" => 380683,
        "11-29" => 380873,
        "11-30" => 381109,
        "12-01" => 381366,
        "12-02" => 381538,
        "12-03" => 381686,
        "12-04" => 381860,
        "12-05" => 382105,
        "12-06" => 382298,
        "12-07" => 382510,
        "12-08" => 382650,
        "12-09" => 382806,
        "12-10" => 383024,
        "12-11" => 383204,
        "12-12" => 383333,
        "12-13" => 383521,
        "12-14" => 383675,
        "12-15" => 383889,
        "12-16" => 384067,
        "12-17" => 384185,
        "12-18" => 384390,
        "12-19" => 384530,
        "12-20" => 384722,
        "12-21" => 384864,
        "12-22" => 385016,
        "12-23" => 385104,
        "12-24" => 385243,
        "12-25" => 385385,
        "12-26" => 385559,
        "12-27" => 385743,
        "12-28" => 385916,
        "12-29" => 386159,
        "12-30" => 386329,
        "12-31" => 386519,
        "year" => 386751,
    ];
}
